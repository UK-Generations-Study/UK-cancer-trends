<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Z">

<title>PAF</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="PAF_paper_files/libs/clipboard/clipboard.min.js"></script>
<script src="PAF_paper_files/libs/quarto-html/quarto.js"></script>
<script src="PAF_paper_files/libs/quarto-html/popper.min.js"></script>
<script src="PAF_paper_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="PAF_paper_files/libs/quarto-html/anchor.min.js"></script>
<link href="PAF_paper_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="PAF_paper_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="PAF_paper_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="PAF_paper_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="PAF_paper_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#population-attributable-fractions-paf-project" id="toc-population-attributable-fractions-paf-project" class="nav-link active" data-scroll-target="#population-attributable-fractions-paf-project">Population Attributable Fractions (PAF) project</a>
  <ul>
  <li><a href="#literature-review" id="toc-literature-review" class="nav-link" data-scroll-target="#literature-review">Literature Review</a></li>
  <li><a href="#analysis-overview" id="toc-analysis-overview" class="nav-link" data-scroll-target="#analysis-overview">Analysis Overview</a>
  <ul>
  <li><a href="#sources" id="toc-sources" class="nav-link" data-scroll-target="#sources">Sources</a></li>
  </ul></li>
  <li><a href="#calculations" id="toc-calculations" class="nav-link" data-scroll-target="#calculations">Calculations</a>
  <ul>
  <li><a href="#dietary-risk-factor-calculations" id="toc-dietary-risk-factor-calculations" class="nav-link" data-scroll-target="#dietary-risk-factor-calculations">Dietary Risk Factor Calculations</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#analysis-and-results" id="toc-analysis-and-results" class="nav-link" data-scroll-target="#analysis-and-results">Analysis and Results</a>
  <ul>
  <li><a href="#preparing-the-data" id="toc-preparing-the-data" class="nav-link" data-scroll-target="#preparing-the-data">Preparing the Data</a></li>
  <li><a href="#paf-relationship" id="toc-paf-relationship" class="nav-link" data-scroll-target="#paf-relationship">PAF relationship</a></li>
  <li><a href="#risk-factor-trends" id="toc-risk-factor-trends" class="nav-link" data-scroll-target="#risk-factor-trends">Risk Factor Trends</a>
  <ul>
  <li><a href="#dietary-risk-factors" id="toc-dietary-risk-factors" class="nav-link" data-scroll-target="#dietary-risk-factors">Dietary Risk Factors</a></li>
  <li><a href="#alcohol-predictions" id="toc-alcohol-predictions" class="nav-link" data-scroll-target="#alcohol-predictions">Alcohol Predictions</a></li>
  </ul></li>
  <li><a href="#cancer-case-trends" id="toc-cancer-case-trends" class="nav-link" data-scroll-target="#cancer-case-trends">Cancer Case Trends</a></li>
  <li><a href="#paf-by-cancer-site" id="toc-paf-by-cancer-site" class="nav-link" data-scroll-target="#paf-by-cancer-site">PAF by Cancer Site</a>
  <ul>
  <li><a href="#lung" id="toc-lung" class="nav-link" data-scroll-target="#lung">1. Lung</a></li>
  <li><a href="#colorectal" id="toc-colorectal" class="nav-link" data-scroll-target="#colorectal">2. Colorectal</a></li>
  <li><a href="#pancreas" id="toc-pancreas" class="nav-link" data-scroll-target="#pancreas">3. Pancreas</a></li>
  <li><a href="#breast" id="toc-breast" class="nav-link" data-scroll-target="#breast">4. Breast</a></li>
  <li><a href="#oesophageal-scc" id="toc-oesophageal-scc" class="nav-link" data-scroll-target="#oesophageal-scc">5. Oesophageal SCC</a></li>
  <li><a href="#oesophageal-ac" id="toc-oesophageal-ac" class="nav-link" data-scroll-target="#oesophageal-ac">6. Oesophageal AC</a></li>
  </ul></li>
  <li><a href="#paf-by-risk-factor" id="toc-paf-by-risk-factor" class="nav-link" data-scroll-target="#paf-by-risk-factor">PAF by Risk Factor</a>
  <ul>
  <li><a href="#smoking" id="toc-smoking" class="nav-link" data-scroll-target="#smoking">1.Smoking</a></li>
  <li><a href="#bmi" id="toc-bmi" class="nav-link" data-scroll-target="#bmi">2.BMI</a></li>
  <li><a href="#alcohol" id="toc-alcohol" class="nav-link" data-scroll-target="#alcohol">3.Alcohol</a></li>
  <li><a href="#dietary-factorsfiber-processed-meat-red-meat" id="toc-dietary-factorsfiber-processed-meat-red-meat" class="nav-link" data-scroll-target="#dietary-factorsfiber-processed-meat-red-meat">4.Dietary Factors(Fiber, Processed Meat, Red Meat)</a></li>
  </ul></li>
  <li><a href="#aggregate-paf" id="toc-aggregate-paf" class="nav-link" data-scroll-target="#aggregate-paf">Aggregate PAF</a>
  <ul>
  <li><a href="#tables" id="toc-tables" class="nav-link" data-scroll-target="#tables">Tables</a></li>
  </ul></li>
  <li><a href="#attributable-cases" id="toc-attributable-cases" class="nav-link" data-scroll-target="#attributable-cases">Attributable Cases</a></li>
  <li><a href="#exposure-scenarios" id="toc-exposure-scenarios" class="nav-link" data-scroll-target="#exposure-scenarios">Exposure Scenarios</a>
  <ul>
  <li><a href="#complete-smoking-cessation-and-lung-cancer" id="toc-complete-smoking-cessation-and-lung-cancer" class="nav-link" data-scroll-target="#complete-smoking-cessation-and-lung-cancer">Complete Smoking Cessation and Lung Cancer</a></li>
  <li><a href="#alcohol-limiting-and-oscc-cancer" id="toc-alcohol-limiting-and-oscc-cancer" class="nav-link" data-scroll-target="#alcohol-limiting-and-oscc-cancer">Alcohol Limiting and OSCC Cancer</a></li>
  <li><a href="#bmi-overweight-no-obese-and-oac-cancer" id="toc-bmi-overweight-no-obese-and-oac-cancer" class="nav-link" data-scroll-target="#bmi-overweight-no-obese-and-oac-cancer">BMI Overweight No Obese and OAC Cancer</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#relevant-for-conclusion" id="toc-relevant-for-conclusion" class="nav-link" data-scroll-target="#relevant-for-conclusion">Relevant for Conclusion</a>
  <ul>
  <li><a href="#literature-comparisons" id="toc-literature-comparisons" class="nav-link" data-scroll-target="#literature-comparisons">Literature Comparisons</a>
  <ul>
  <li><a href="#fibre" id="toc-fibre" class="nav-link" data-scroll-target="#fibre">Fibre</a></li>
  <li><a href="#processed-and-red-meat" id="toc-processed-and-red-meat" class="nav-link" data-scroll-target="#processed-and-red-meat">Processed and Red Meat</a></li>
  </ul></li>
  <li><a href="#predictions-in-the-wake-of-covid-19-pandemic" id="toc-predictions-in-the-wake-of-covid-19-pandemic" class="nav-link" data-scroll-target="#predictions-in-the-wake-of-covid-19-pandemic">Predictions in the wake of Covid-19 Pandemic</a></li>
  <li><a href="#limitations" id="toc-limitations" class="nav-link" data-scroll-target="#limitations">Limitations</a></li>
  </ul></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">PAF</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Z </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<section id="population-attributable-fractions-paf-project" class="level1">
<h1>Population Attributable Fractions (PAF) project</h1>
<p>This project is calculating the PAFs over time from 2015 and projecting them in to 2030.</p>
<section id="literature-review" class="level2">
<h2 class="anchored" data-anchor-id="literature-review">Literature Review</h2>
</section>
<section id="analysis-overview" class="level2">
<h2 class="anchored" data-anchor-id="analysis-overview">Analysis Overview</h2>
<p>This project involves the 6 cancer sites that have the top mortality rates in the UK (referencing Positions Paper):</p>
<ol type="1">
<li><p>Lung</p></li>
<li><p>Colorectal</p></li>
<li><p>Pancreatic</p></li>
<li><p>Breast</p></li>
<li><p>Oesophageal (Split by morphology - squamous cell carcinoma (OSCC) and adenocarcinoma (OAC))</p></li>
<li><p>Prostate</p></li>
</ol>
<p>The risk factors were included if they met the following criteria:</p>
<ul>
<li><p>a modifiable risk factor surrounding an individuals lifestyle choices</p></li>
<li><p>classified as having sufficient evidence for a causal relationship from IARC or World Cancer Research Fund</p></li>
</ul>
<p>The final list of risk factors and their exposures that are included in this research project are:</p>
<ol type="1">
<li><p>Smoking</p>
<p>Current Smoking</p>
<p>Former Smoking</p></li>
<li><p>BMI</p>
<p>Obese(30+ BMI)</p>
<p>Overweight(25-30 BMI)</p></li>
<li><p>Alcohol</p>
<p>Light (&lt;12g/day)Drinking</p>
<p>Medium(12-50g/day)Drinking</p>
<p>Heavy (&gt;50g/day) Drinking</p></li>
<li><p>Red Meat</p>
<p>Consuming more than the UK recommended 100g/day</p></li>
<li><p>Processed Meat</p>
<p>Consuming more than the UK recommended 50g/day</p></li>
<li><p>Fibre</p>
<p>Consuming less than the UK recommended 30g/day</p></li>
</ol>
<section id="sources" class="level3">
<h3 class="anchored" data-anchor-id="sources">Sources</h3>
<p>Risk Factor Data</p>
<ul>
<li><p>Alcohol, Smoking, BMI: This data were sourced from cleaned data from the positions paper which were originally sourced from the ONS and collected via the <a href="https://digital.nhs.uk/data-and-information/publications/statistical/health-survey-for-england">Health Survey England (HSE)</a>. The data were requested from the <a href="https://beta.ukdataservice.ac.uk/datacatalogue/studies/study?id=8860">UK Data Service</a> by year.</p></li>
<li><p>Dietary Data: This data were sourced from the <a href="https://www.gov.uk/government/collections/national-diet-and-nutrition-survey">National Diet and Nutrition Survey</a> and downloaded from the <a href="https://beta.ukdataservice.ac.uk/datacatalogue/studies/study?id=6533">UK Data Service</a>.</p></li>
</ul>
<p>Cancer Incidence Data</p>
<ul>
<li><p>Data for all cancer incidences were sourced from cleaned data from the positions paper which were originally sourced from Cancer Research UK and Globocan.</p></li>
<li><p>Additional data on Oesophageal cancer morphology was needed which was sourced from <a href="https://pubmed.ncbi.nlm.nih.gov/29563637/">Offman et al 2018</a> research on projecting trends in OAC and OSCC.</p></li>
</ul>
<p>Risk Ratios</p>
<ul>
<li>Risk ratios were sourced from recent meta-analysis about cancer and the specific risk factors. A list of the sources can be found in Mendeley <a href="https://www.mendeley.com/reference-manager/library/collections/90fc0272-7ce4-4e01-a8c3-0c350cb2a74a/all-references/">here</a> and tracked in the <a href="https://icracuk.sharepoint.com/:f:/r/sites/DescriptiveEpidemiology/Shared%20Documents/PAF/PAFcalculations/Background%20Literature?csf=1&amp;web=1&amp;e=IboMfc">PAF Teams folder</a></li>
</ul>
</section>
</section>
<section id="calculations" class="level2">
<h2 class="anchored" data-anchor-id="calculations">Calculations</h2>
<p>The equation used to calculate the PAFS was the same one referenced in the <a href="https://www.nature.com/articles/s41416-018-0029-6">Brown et al.&nbsp;paper</a> to calculate PAFs with multiple exposure levels:</p>
<p><span class="math display">\[
  PAF = \frac {(p_1 * ERR_1)+(p_2 * ERR_2)+(p_3 * ERR_3)...(p_n * ERR_n)} {1+(p_1 * ERR_1)+(p_2 * ERR_2)+(p_3 * ERR_3)...(p_n * ERR_n)}
  \]</span> where:</p>
<ul>
<li><p>pn = population exposure prevalence of risk factor n</p></li>
<li><p>ERRn = Excess Relative Risk = (RR at exposure level n) - 1</p></li>
</ul>
<p>There are many assumptions that are made when calculating PAFs</p>
<ol type="1">
<li><p>Causality between the risk factor and the outcome</p></li>
<li><p>Accurate measurement of the relative risk and exposure prevalence</p></li>
<li><p>Removing the risk factor from the population would remove the risk of the outcome</p></li>
<li><p>The exposure is removable from the popualtion</p></li>
<li><p>All other risk factors remain constant</p></li>
</ol>
<section id="dietary-risk-factor-calculations" class="level3">
<h3 class="anchored" data-anchor-id="dietary-risk-factor-calculations">Dietary Risk Factor Calculations</h3>
<p>These dietary risk factors do not have clearly defined exposed and unexposed categories.</p>
<p>Instead, categories of consumption were created from the National Diet and Nutrition Survey and RR were broken down to risk per g of increase. Risk at each category was calculated based on risk of consumption at the midpoint of the category.</p>
</section>
</section>
</section>
<section id="analysis-and-results" class="level1">
<h1>Analysis and Results</h1>
<section id="preparing-the-data" class="level2">
<h2 class="anchored" data-anchor-id="preparing-the-data">Preparing the Data</h2>
<p>Running the background code and installing all of the necessary packages</p>
</section>
<section id="paf-relationship" class="level2">
<h2 class="anchored" data-anchor-id="paf-relationship">PAF relationship</h2>
<p>Looking at how the PAF change as the population risk factor exposure ranges from 0-100% with different constant relative risks.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="PAF_paper_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="risk-factor-trends" class="level2">
<h2 class="anchored" data-anchor-id="risk-factor-trends">Risk Factor Trends</h2>
<p>The risk factors trending over the past 2 decades.:</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="PAF_paper_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="PAF_paper_files/figure-html/unnamed-chunk-4-2.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
</div>
<section id="dietary-risk-factors" class="level3">
<h3 class="anchored" data-anchor-id="dietary-risk-factors">Dietary Risk Factors</h3>
<p>Bar graphs of prevalence of different levels of exposure consumption.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="PAF_paper_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="PAF_paper_files/figure-html/unnamed-chunk-5-2.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="PAF_paper_files/figure-html/unnamed-chunk-5-3.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="alcohol-predictions" class="level3">
<h3 class="anchored" data-anchor-id="alcohol-predictions">Alcohol Predictions</h3>
<p>The Health Survey England (HSE) only has data through 2011. Data previously, whether from the HSE or from the old UK wide General Household Survey (ended in 2007), is not comparable as they ask the question is phrased in a different way. This results in prevalence of light drinkers in English men in 2005 being 10% less than what is reported in the same population in 2011 in the HSE. This is alarming as the prevalence of light drinkers in English men in the HSE does not vary by more than 3% from 2011-2019.</p>
<p>As a consequence, prevalence of alcohol consumption in men and women in England was project back using the HSE data and logistic regression. The results can be seen below:</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="PAF_paper_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="cancer-case-trends" class="level2">
<h2 class="anchored" data-anchor-id="cancer-case-trends">Cancer Case Trends</h2>
<p>How cancer incidence changes over time. These are absolute cases so they do not account for the ageing population or population growth.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="PAF_paper_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="PAF_paper_files/figure-html/unnamed-chunk-7-2.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="paf-by-cancer-site" class="level2">
<h2 class="anchored" data-anchor-id="paf-by-cancer-site">PAF by Cancer Site</h2>
<p>How the individual risk factor PAFs trend over time by cancer site:</p>
<section id="lung" class="level3">
<h3 class="anchored" data-anchor-id="lung">1. Lung</h3>
<p>Estimates for Population Attributable Fractions on Lung Cancer</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="PAF_paper_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="colorectal" class="level3">
<h3 class="anchored" data-anchor-id="colorectal">2. Colorectal</h3>
<p>Estimates for Population Attributable Fractions on Colorectal Cancer</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="PAF_paper_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="PAF_paper_files/figure-html/unnamed-chunk-10-2.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="pancreas" class="level3">
<h3 class="anchored" data-anchor-id="pancreas">3. Pancreas</h3>
<p>Estimates for Population Attributable Fractions on Pancreas Cancer</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="PAF_paper_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="breast" class="level3">
<h3 class="anchored" data-anchor-id="breast">4. Breast</h3>
<p>Estimates for Population Attributable Fractions on Breast Cancer</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="PAF_paper_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="oesophageal-scc" class="level3">
<h3 class="anchored" data-anchor-id="oesophageal-scc">5. Oesophageal SCC</h3>
<p>Estimates for Population Attributable Fractions on OSCC Cancer</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="PAF_paper_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="oesophageal-ac" class="level3">
<h3 class="anchored" data-anchor-id="oesophageal-ac">6. Oesophageal AC</h3>
<p>Estimates for Population Attributable Fractions on OAC Cancer</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="PAF_paper_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="paf-by-risk-factor" class="level2">
<h2 class="anchored" data-anchor-id="paf-by-risk-factor">PAF by Risk Factor</h2>
<p>How the individual risk factor PAFs trend over time grouped by risk factor:</p>
<section id="smoking" class="level3">
<h3 class="anchored" data-anchor-id="smoking">1.Smoking</h3>
<p>Smoking as a Cancer Risk Factor</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="PAF_paper_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="bmi" class="level3">
<h3 class="anchored" data-anchor-id="bmi">2.BMI</h3>
<p>BMI as a Cancer Risk Factor</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="PAF_paper_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="PAF_paper_files/figure-html/unnamed-chunk-17-2.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="alcohol" class="level3">
<h3 class="anchored" data-anchor-id="alcohol">3.Alcohol</h3>
<p>Alcohol as a Cancer Risk Factor</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="PAF_paper_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="PAF_paper_files/figure-html/unnamed-chunk-18-2.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="dietary-factorsfiber-processed-meat-red-meat" class="level3">
<h3 class="anchored" data-anchor-id="dietary-factorsfiber-processed-meat-red-meat">4.Dietary Factors(Fiber, Processed Meat, Red Meat)</h3>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="PAF_paper_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="aggregate-paf" class="level2">
<h2 class="anchored" data-anchor-id="aggregate-paf">Aggregate PAF</h2>
<p>Aggregate PAFs for each cancer site that include the risk factors investigated in this project:</p>
<ol type="1">
<li>BMI</li>
<li>Smoking</li>
<li>Alcohol</li>
<li>Dietary Factors (Fiber, Processed Meat, Red Meat)</li>
</ol>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="PAF_paper_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="PAF_paper_files/figure-html/unnamed-chunk-20-2.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
</div>
<section id="tables" class="level3">
<h3 class="anchored" data-anchor-id="tables">Tables</h3>
<p>PAF table for Men</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>

| Year | Lung  | Pancreas |  AC   |  SCC  | Colorectal |
|:----:|:-----:|:--------:|:-----:|:-----:|:----------:|
| 2005 | 72.76 |  23.83   | 57.89 | 73.67 |    0.00    |
| 2006 | 70.73 |  22.45   | 57.31 | 72.14 |    0.00    |
| 2007 | 70.69 |  22.45   | 57.04 | 71.98 |    0.00    |
| 2008 | 70.53 |  22.40   | 57.13 | 71.69 |   43.14    |
| 2009 | 70.60 |  22.10   | 56.69 | 71.56 |   42.81    |
| 2010 | 69.41 |  21.92   | 57.31 | 70.65 |   42.90    |
| 2011 | 70.31 |  22.17   | 56.83 | 71.15 |   42.36    |
| 2012 | 69.30 |  21.55   | 56.53 | 70.28 |   42.78    |
| 2013 | 70.80 |  22.90   | 57.91 | 71.11 |   43.18    |
| 2014 | 68.55 |  21.06   | 55.93 | 69.40 |   41.52    |
| 2015 | 67.14 |  20.53   | 56.28 | 68.07 |   41.83    |
| 2016 | 67.85 |  20.83   | 56.02 | 68.55 |   40.33    |
| 2017 | 67.17 |  20.65   | 56.27 | 67.42 |   40.31    |
| 2018 | 66.64 |  20.12   | 55.77 | 67.76 |   40.38    |
| 2019 | 66.27 |  20.01   | 55.81 | 67.33 |    0.00    |</code></pre>
</div>
</div>
<p>PAF table for women</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>

| Year | Lung  | Pancreas |  AC   |  SCC  | Breast | Colorectal |
|:----:|:-----:|:--------:|:-----:|:-----:|:------:|:----------:|
| 2005 | 65.43 |  21.67   | 54.12 | 64.68 | 14.05  |    0.00    |
| 2006 | 63.76 |  20.57   | 53.31 | 63.38 | 13.95  |    0.00    |
| 2007 | 63.47 |  20.42   | 53.24 | 63.04 | 13.92  |    0.00    |
| 2008 | 62.82 |  20.10   | 53.20 | 62.47 | 13.92  |   36.84    |
| 2009 | 63.14 |  20.11   | 53.05 | 62.58 | 13.76  |   36.66    |
| 2010 | 61.50 |  19.51   | 53.03 | 61.31 | 13.93  |   36.41    |
| 2011 | 61.66 |  19.56   | 53.14 | 61.40 | 13.96  |   36.44    |
| 2012 | 60.52 |  18.83   | 52.14 | 60.75 | 13.86  |   35.61    |
| 2013 | 60.63 |  18.64   | 52.01 | 59.98 | 13.36  |   35.25    |
| 2014 | 59.31 |  18.47   | 52.13 | 58.99 | 13.63  |   35.40    |
| 2015 | 60.01 |  18.82   | 52.64 | 59.56 | 13.62  |   35.58    |
| 2016 | 58.62 |  18.09   | 51.77 | 58.70 | 13.57  |   34.38    |
| 2017 | 58.84 |  18.70   | 53.49 | 58.49 | 13.96  |   35.25    |
| 2018 | 58.37 |  18.37   | 52.76 | 58.36 | 13.83  |   34.91    |
| 2019 | 56.95 |  17.68   | 52.03 | 57.15 | 13.87  |    0.00    |</code></pre>
</div>
</div>
<p>Relative change in PAF from 2005-2019 (except for Colorectal which will be from 2008-2018)</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 11 × 5
   cancersite sex   `2005` `2019` PAF_Change
   &lt;chr&gt;      &lt;chr&gt;  &lt;dbl&gt;  &lt;dbl&gt;      &lt;dbl&gt;
 1 Lung       Women   65.4   57.0      -8.47
 2 Pancreas   Women   21.7   17.7      -3.99
 3 AC         Women   54.1   52.0      -2.09
 4 SCC        Women   64.7   57.2      -7.53
 5 Breast     Women   14.0   13.9      -0.18
 6 Colorectal Women   36.8   34.9      -1.93
 7 Lung       Men     72.8   66.3      -6.49
 8 Pancreas   Men     23.8   20.0      -3.82
 9 AC         Men     57.9   55.8      -2.08
10 SCC        Men     73.7   67.3      -6.33
11 Colorectal Men     43.1   40.4      -2.76</code></pre>
</div>
</div>
</section>
</section>
<section id="attributable-cases" class="level2">
<h2 class="anchored" data-anchor-id="attributable-cases">Attributable Cases</h2>
<p>Using the historical incident cancer cases from the National Cancer Registry and a 10 year time lag between the PAFS and the year that it effects, the attributable cancer cases were calculated.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="PAF_paper_files/figure-html/unnamed-chunk-24-1.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="PAF_paper_files/figure-html/unnamed-chunk-24-2.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="exposure-scenarios" class="level2">
<h2 class="anchored" data-anchor-id="exposure-scenarios">Exposure Scenarios</h2>
<section id="complete-smoking-cessation-and-lung-cancer" class="level3">
<h3 class="anchored" data-anchor-id="complete-smoking-cessation-and-lung-cancer">Complete Smoking Cessation and Lung Cancer</h3>
<p>Based in 2019, if all current smokers stopped smoking and no one starts smoking</p>
<p>At the far right of the x-axis, the assumption is:</p>
<p>former smoking prevalence = current smoking prevalence + former smoking prevalence</p>
<p>current smoking prevalence = 0</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="PAF_paper_files/figure-html/unnamed-chunk-25-1.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
</div>
<p>The conclusion that can be drawn here is that even if it were possible to remove all current smokers from the population by getting them to quit smoking, there would still be a large proportion of lung cancer cases attributable to the longitudinal effects of smoking. This means that the only way to truly remove smoking as a lung cancer risk factor from the population would be for universal smoking cessation and time for those who have ever been cigarette smoking to age out of the population.</p>
<p>Here are the actual smoking PAFs in 2019 vs.&nbsp;the PAFS with total smoking cessation (assumptions outlined above) for each cancer site.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="PAF_paper_files/figure-html/unnamed-chunk-26-1.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="alcohol-limiting-and-oscc-cancer" class="level3">
<h3 class="anchored" data-anchor-id="alcohol-limiting-and-oscc-cancer">Alcohol Limiting and OSCC Cancer</h3>
<p>Based on 2019, if all drinkers in England started limiting their alcohol consumption to light alcohol consumption.</p>
<p>OSCC cancer was chosen because it is the cancer site with the highest RR so the effect would be the most dramatic. This is the cancer site that would be the most affected by changes in alcohol consumption prevalence.</p>
<p>Light alcohol consumption is classified as 1.5 units of alcohol per day which is about one drink. This definition is about what the UK guidelines recommend as healthy alcohol habits ( 14 units per week). That means that this scenario is if all drinkers in England 2019 decided to listen to government health interventions and drink appropriately.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="PAF_paper_files/figure-html/unnamed-chunk-27-1.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
</div>
<p>The assumptions behind this scenario are that all drinkers in England 2019 continue drinking but limit their consumption to light drinkers and there are no new drinkers entering the “exposed” population.</p>
<p>Here are the actual alcohol PAFs in 2019 vs.&nbsp;the PAFS with alcohol limiting assumptions (assumptions outlined above) for each cancer site.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="PAF_paper_files/figure-html/unnamed-chunk-28-1.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="bmi-overweight-no-obese-and-oac-cancer" class="level3">
<h3 class="anchored" data-anchor-id="bmi-overweight-no-obese-and-oac-cancer">BMI Overweight No Obese and OAC Cancer</h3>
<p>In this scenario, all obese people in 2019 have moved in to the overweight BMI category. OAC was chosen for the same reasons as OSCC cancer was chosen for Alcohol. The scenario is also the same set of assumptions -the whole England population moves to the lowest risk group.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="PAF_paper_files/figure-html/unnamed-chunk-29-1.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
</div>
<p>The assumptions behind this scenario are that all people in the BMI “risk” category (overweight/obesity) stay in the category and there are no people entering this risk group.</p>
<p>Here are the actual BMI PAFs in 2019 vs.&nbsp;the PAFS with BMI limiting assumptions (assumptions outlined above) for each cancer site.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="PAF_paper_files/figure-html/unnamed-chunk-30-1.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
</section>
<section id="relevant-for-conclusion" class="level1">
<h1>Relevant for Conclusion</h1>
<section id="literature-comparisons" class="level2">
<h2 class="anchored" data-anchor-id="literature-comparisons">Literature Comparisons</h2>
<section id="fibre" class="level3">
<h3 class="anchored" data-anchor-id="fibre">Fibre</h3>
<p>One of the biggest discrepancies between current PAF literature and this analysis is the RR for fibre. The RR used in this analysis is 0.91(0.87, 1.00) per 10g increment of fibre per day and is sourced from a meta-analysis from the <a href="https://www.wcrf.org/wp-content/uploads/2020/12/Wholegrains-veg-and-fruit.pdf">WCRF</a>.The RR can be transformed to be an ERR per 1g/day by:<br>
<span class="math display">\[
per 1 g deficit  = ln(\frac1{0.93}) = \frac {0.073}{10g} / 10 = \frac {0.007}{1g}
\]</span> The methodology is described in <a href="https://pubmed.ncbi.nlm.nih.gov/29567982/">Brown et al.</a>. The problem is that the reported RR per 1g of fibre deficit in the methodology is 0.03 per 1g deficit which is significantly larger than the one used in this analysis.</p>
<p>This number is sourced from this <a href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC3252068/">Parkin, 2011 paper</a>. In this paper, it is acknowledged that the WCRF published a similar number to 0.93; however, it uses a RR of 0.84 per 6g from <a href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC3252068/">Dahm, 2010</a>which resulted in the reported 3% per 1g increase in risk that is used in the Parkin paper: <span class="math display">\[
per 1 g deficit = ln(\frac1{0.84}) = \frac {0.174}{6g} / 6 = \frac {0.029}{1g}
\]</span></p>
<p>This number has been widely used throughout literature - <a href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC11064977/">Goon, 2021</a> - and drastically overestimates the PAF for fibre and colorectal cancer.</p>
</section>
<section id="processed-and-red-meat" class="level3">
<h3 class="anchored" data-anchor-id="processed-and-red-meat">Processed and Red Meat</h3>
<p>The PAF in Brown et al.&nbsp;for processed and red meat was calculated based on the population prevalence of red and processed meat together but the RR used is for processed meat - 74g/day of processed meat on average with an RR 1.13. This is an overestimate of the meat diet PAF calculations because not all of this 74g is processed meat.</p>
<p>In this analysis, processed meat and red meat are calculated separately with different RR and different prevalence from the NDNS based on IARC definitions of red and processed meat.</p>
</section>
</section>
<section id="predictions-in-the-wake-of-covid-19-pandemic" class="level2">
<h2 class="anchored" data-anchor-id="predictions-in-the-wake-of-covid-19-pandemic">Predictions in the wake of Covid-19 Pandemic</h2>
<p>Looking at the Health Survey England 2022 results to look at how the population prevalence of the main risk factors - alcohol, smoking, BMI - was effected by Covid-19. The HSE survey did not go ahead in 2020 but continued in 2021 and 2022.</p>
<ol type="1">
<li><p>Smoking: In 2022, the self reported prevalence of current smokers drops by 5% in both male and female adults when compared to 2019 prevalence.</p></li>
<li><p>Alcohol: In 2022,the self reported prevalence of alcohol consumption at all levels is relatively the same when compared to 2019 prevalence.</p></li>
<li><p>BMI: In 2022, the self reported prevalence of obesity and overweight is relatively the same when compared to 2019 prevalence (within 2%).</p></li>
</ol>
</section>
<section id="limitations" class="level2">
<h2 class="anchored" data-anchor-id="limitations">Limitations</h2>
<p>The Brown et al.&nbsp;paper lists limitations for PAF calculations that should be considered. These are relevant for these calculations as well:</p>
<ul>
<li><p>Bias PAF estimates to be an underestimation of true population measures because:</p>
<ul>
<li><p>PAFs are based on the best available data so limitations of the source data should be considered</p>
<pre><code>  - Risk factor data is prone to self reporting errors (underestimate) </code></pre></li>
<li><p>IARC classified sufficient/convincing causal link for risk factor inclusion criteria as there may be inclusion-worthy risk factors that haven’t reached this level</p></li>
<li><p>Confounding cannot be ruled out through quality of relative risk evidence. (Example given unexposed group in alcohol RR could include ex and occasional drinkers which would dilute the measure.</p></li>
<li><p>The method of summing individual PAFs to reach an overall number inherently underestimates the number because it doesn’t take the effect of risk factors in combination</p></li>
</ul></li>
<li><p>Blanket 10-year latency between PAF and incidence cases because the risk factor prevalence data does not have high quality historical data to have a 30-year latency</p>
<ul>
<li>Using custom time lag for each cancer site and risk factor would be unsystematic and reduced comparability</li>
</ul></li>
</ul>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>